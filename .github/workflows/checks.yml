name: Checks

on:
  pull_request:
    branches: [ main ]

jobs:
  checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.20'

      - name: Ensure GOPATH/bin is on PATH
        run: echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Install golangci-lint
        run: go install github.com/golangci/golangci-lint/cmd/golangci-lint@v1.55.2

      - name: Build the uniq binary
        # run build from the nested module so `go` sees its go.mod
        working-directory: bashnya-hw4/uniq
        run: go build -v -o ../../uniq ./cmd

      - name: Lint
        # run linter from the module directory so it lints the module sources
        working-directory: bashnya-hw4/uniq
        run: |
          if command -v golangci-lint >/dev/null 2>&1; then
            if [ -f ./.golangci-lint.yml ]; then
              golangci-lint run -v -c ./.golangci-lint.yml ./...
            else
              golangci-lint run -v ./...
            fi
          else
            echo "golangci-lint not found in PATH"; exit 1
          fi

      - name: Unit tests
        # run tests inside the nested module explicitly
        working-directory: bashnya-hw4/uniq
        run: go test -v ./...

      - name: Acceptance tests
        # run acceptance script with bash to avoid execution-bit issues
        run: bash ./acceptance-tests/tests.sh
